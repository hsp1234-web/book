
#@title ğŸ”¬ å¼·åŠ›åœ–è¡¨æ“·å–å™¨ V25 (ç´”ç²¹æ“·å–ç‰ˆ)
#@markdown > **æ“ä½œæµç¨‹ï¼š**
#@markdown > 1. **è¨­å®šåƒæ•¸**ï¼šé»æ“Šä¸‹æ–¹å„å€å¡Šçš„ **â–º** ä¾†å±•é–‹è©³ç´°èªªæ˜ä¸¦è¨­å®šåƒæ•¸ã€‚
#@markdown > 2. **åŸ·è¡Œä¸¦ä¸Šå‚³**ï¼š**åŸ·è¡Œæ­¤å„²å­˜æ ¼ (â–¶ï¸)**ï¼Œä¸¦é»æ“Šåº•éƒ¨å‡ºç¾çš„ **ã€Œé¸æ“‡æª”æ¡ˆã€** æŒ‰éˆ•ä¸Šå‚³åœ–ç‰‡ã€‚
#@markdown > 3. **åˆ†æèˆ‡è¿­ä»£**ï¼šç¨‹å¼å°‡ç«‹å³å‘ˆç¾è¦–è¦ºåŒ–å ±å‘Šã€‚æ‚¨å¯ä»¥æ ¹æ“šå ±å‘Šä¸­çš„å»ºè­°ï¼Œå›åˆ°æ­¤è™•æ‰‹å‹•æ›´æ–°åƒæ•¸ï¼Œç„¶å¾Œ**é‡æ–°åŸ·è¡Œå„²å­˜æ ¼**ï¼Œç›´åˆ°ç²å¾—æœ€æ»¿æ„çš„æ“·å–çµæœã€‚

#@markdown ---
#@markdown ### ğŸŸ¢ **ç¬¬ä¸€å€ï¼šè¼ªå»“åµæ¸¬éˆæ•åº¦**
#@markdown <details>
#@markdown <summary>â–º é»æ­¤å±•é–‹/æ”¶åˆè©³ç´°èªªæ˜</summary>
#@markdown > **æ ¸å¿ƒæŠ€å·§ï¼š** é€™æ˜¯æ±ºå®šã€Œèƒ½å¦æ‰¾åˆ°ã€åœ–è¡¨çš„**æœ€é—œéµ**å€åŸŸã€‚å¦‚æœåœ–è¡¨åœ¨é™°å½±ä¸­æˆ–é‚Šæ¡†ä¸æ¸…æ™°å°è‡´**åµæ¸¬ä¸å…¨**ï¼Œè«‹å„ªå…ˆèª¿æ•´æ­¤è™•çš„æ»‘æ¡¿ã€‚
#@markdown ---
#@markdown **`è‡ªé©æ‡‰é–¾å€¼è¨ˆç®—å€å¡Šå¤§å° (adaptive_block_size)`**
#@markdown
#@markdown * **ç™½è©±èªªæ˜**ï¼šé€™æ˜¯ç¨‹å¼åœ¨åˆ¤æ–·ä¸€å€‹åƒç´ é»ã€Œè©²è®Šé»‘é‚„æ˜¯è®Šç™½ã€æ™‚ï¼Œè¦åƒè€ƒå‘¨åœå¤šå¤§ç¯„åœçš„é„°å±…ã€‚
#@markdown * **èª¿æ•´æ•ˆæœ**ï¼š
#@markdown     * **èª¿é«˜**ï¼šç¨‹å¼çš„ã€Œè¦–é‡ã€è®Šå¤§ï¼Œæ›´èƒ½æŠµæŠ—æ›¸é ä¸Š**å…‰ç…§ä¸å‡æˆ–é™°å½±**çš„å½±éŸ¿ã€‚å¦‚æœæ‚¨çš„ç…§ç‰‡æœ‰çš„åœ°æ–¹äº®ã€æœ‰çš„åœ°æ–¹æš—ï¼Œå°è‡´åœ–è¡¨é‚Šæ¡†æ–·è£‚ï¼Œè«‹**å„ªå…ˆèª¿é«˜**æ­¤æ•¸å€¼ã€‚
#@markdown     * **èª¿ä½**ï¼šç¨‹å¼çš„ã€Œè¦–é‡ã€è®Šå°ï¼Œèƒ½æ›´å¥½åœ°ä¿ç•™å¾®å°çš„ç´°ç¯€ï¼Œä½†å°å…‰ç…§è®ŠåŒ–æœƒæ›´æ•æ„Ÿã€‚
#@markdown </details>
adaptive_block_size = 51 #@param {type:"slider", min:3, max:101, step:2}

#@markdown <details>
#@markdown <summary>â–º é»æ­¤å±•é–‹/æ”¶åˆè©³ç´°èªªæ˜</summary>
#@markdown **`è‡ªé©æ‡‰é–¾å€¼åç§»é‡ (adaptive_c_value)`**
#@markdown
#@markdown * **ç™½è©±èªªæ˜**ï¼šé€™æ˜¯åœ¨ç¨‹å¼ç®—å‡ºä¸€å€‹åƒç´ é»çš„é»‘ç™½åˆ†ç•Œç·šå¾Œï¼Œå†æ‰‹å‹•å¾®èª¿çš„ä¸€å€‹ã€Œå¯¬å®¹åº¦ã€ã€‚
#@markdown * **èª¿æ•´æ•ˆæœ**ï¼š
#@markdown     * **èª¿é«˜**ï¼šç›¸ç•¶æ–¼æ”¾å¯¬æ¨™æº–ï¼Œæœƒè®“æ›´å¤š**æ¯”è¼ƒæ·º**çš„ç°è‰²ç·šæ¢ä¹Ÿè¢«åˆ¤æ–·ç‚ºã€Œé»‘è‰²ã€ã€‚å¦‚æœåœ–è¡¨æ˜¯ç”¨æ¯”è¼ƒæ·¡çš„å¢¨æ°´å°çš„ï¼Œå°è‡´æ‰¾ä¸åˆ°ï¼Œå¯ä»¥è©¦è‘—**èª¿é«˜**æ­¤æ•¸å€¼ã€‚
#@markdown     * **èª¿ä½**ï¼šæ¨™æº–è®Šåš´æ ¼ï¼Œåªæœ‰éå¸¸é»‘çš„ç·šæ¢æ‰æœƒè¢«ä¿ç•™ã€‚
#@markdown </details>
adaptive_c_value = 10 #@param {type:"slider", min:1, max:20, step:1}

#@markdown ---
#@markdown ### ğŸŸ¢ **ç¬¬äºŒå€ï¼šè¼ªå»“ç¯©é¸æ¨™æº–**
#@markdown <details>
#@markdown <summary>â–º é»æ­¤å±•é–‹/æ”¶åˆè©³ç´°èªªæ˜</summary>
#@markdown > **æ ¸å¿ƒæŠ€å·§ï¼š** é€™æ˜¯æ±ºå®šã€Œæ‰¾å¾—æº–ä¸å‡†ã€çš„é—œéµã€‚é¦–æ¬¡åŸ·è¡Œå¾Œï¼Œå°‡ä¸‹æ–¹å ±å‘Šä¸­ã€Œæ™ºæ…§æ¨è–¦ã€çš„æ•¸å€¼å¡«å…¥æ­¤è™•ï¼Œå¯ä»¥éæ¿¾æ‰çµ•å¤§å¤šæ•¸çš„é›œè¨Šã€‚
#@markdown </details>
min_chart_area_k = 100 #@param {type:"integer"}
max_chart_area_k = 8000 #@param {type:"integer"}
min_aspect_ratio = 0.8 #@param {type:"number"}
max_aspect_ratio = 1.5 #@param {type:"number"}

#@markdown ---
#@markdown ### ğŸŸ¢ **ç¬¬ä¸‰å€ï¼šæ“·å–è¨­å®š**
#@markdown <details>
#@markdown <summary>â–º é»æ­¤å±•é–‹/æ”¶åˆè©³ç´°èªªæ˜</summary>
#@markdown > **æ ¸å¿ƒæŠ€å·§ï¼š** é€™æ˜¯æ±ºå®šæœ€çµ‚æ“·å–å‡ºåœ–è¡¨**ç¯„åœ**çš„å”¯ä¸€åƒæ•¸ã€‚
#@markdown </details>
padding_expansion_percent = 20 #@param {type:"slider", min:0, max:100, step:5}
#@markdown `æ“·å–é‚Šç•Œæ“´å¼µ (%)`: ä»¥åœ–è¡¨çš„**é•·é‚Š**ç‚º 100% åŸºæº–ï¼Œå¾åŸåœ–æ“´å¼µè£åˆ‡ç¯„åœã€‚`0` ä»£è¡¨ä¸æ“´å¼µï¼Œç›´æ¥è£åˆ‡åœ–è¡¨åµæ¸¬åˆ°çš„é‚Šç•Œã€‚

# ==============================================================================
# Part A: ç’°å¢ƒæº–å‚™èˆ‡å‡½å¼åº«å°å…¥
# ==============================================================================
import cv2
import numpy as np
from IPython.display import display, HTML, clear_output
from PIL import Image
import io
from google.colab import files

# ==============================================================================
# Part B: æ ¸å¿ƒè™•ç†æµç¨‹èˆ‡å ±å‘Šç”Ÿæˆ
# ==============================================================================
def process_image_and_report(file_content):
    """
    ä¸»è™•ç†å‡½å¼ã€‚æ­¤ç‰ˆæœ¬åªé€²è¡Œåµæ¸¬ã€åˆ†æèˆ‡ç›´æ¥è£åˆ‡ï¼Œä¸åŒ…å«ä»»ä½•è®Šå½¢æ ¡æ­£ã€‚
    """
    # --- æ­¥é©Ÿ 0: è®€å–åœ–ç‰‡ä¸¦è½‰æ›å–®ä½ ---
    min_area = min_chart_area_k * 1000
    max_area = max_chart_area_k * 1000
    np_arr = np.frombuffer(file_content, np.uint8)
    original_image = cv2.imdecode(np_arr, cv2.IMREAD_COLOR)

    # --- æ­¥é©Ÿ 1: å½±åƒå‰è™•ç†èˆ‡è¼ªå»“åµæ¸¬ ---
    gray_image = cv2.cvtColor(original_image, cv2.COLOR_BGR2GRAY)
    blurred_image = cv2.GaussianBlur(gray_image, (5, 5), 0)
    binary_image = cv2.adaptiveThreshold(blurred_image, 255, cv2.ADAPTIVE_THRESH_GAUSSIAN_C, cv2.THRESH_BINARY_INV, adaptive_block_size, adaptive_c_value)
    contours, _ = cv2.findContours(binary_image, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    found_charts_data, all_contours_for_viz = [], []
    for contour in contours:
        area = cv2.contourArea(contour)
        x, y, w, h = cv2.boundingRect(contour)
        if h == 0: continue
        aspect_ratio = w / float(h)
        is_accepted = (min_area < area < max_area) and (min_aspect_ratio < aspect_ratio < max_aspect_ratio)
        if is_accepted:
            found_charts_data.append({"contour": contour, "area": area, "rect": (x,y,w,h), "aspect_ratio": aspect_ratio})
        all_contours_for_viz.append({'contour': contour, 'accepted': is_accepted})

    # --- æ­¥é©Ÿ 2: ç”¢ç”Ÿå ±å‘Šçš„ HTML çµæ§‹èˆ‡æ™ºæ…§æ¨è–¦ ---
    clear_output(wait=True)
    report_style = "<style>details{border:1px solid #aaa;border-radius:4px;padding: .5em .5em 0;}summary{font-weight:bold;margin:-.5em -.5em 0;padding:.5em;cursor:pointer;}details[open]{padding:.5em;}details[open] summary{border-bottom:1px solid #aaa;margin-bottom:.5em;}.report-container{background-color:white;color:black;padding:15px;border-radius:8px;border:1px solid #ddd;margin-top:1em;}.report-container h2,.report-container h3,.report-container h4{color:black;margin-top:0;}.report-container code{background-color:#eee;padding:2px 5px;border-radius:4px;}.report-container table{border-collapse:collapse;width:100%;margin-top:10px;}.report-container th,.report-container td{border:1px solid #ccc;padding:8px;text-align:left;}.report-container th{background-color:#f2f2f2;}</style>"
    display(HTML(report_style))
    report_html = f'<div class="report-container"><h2>ğŸ“Š è¦–è¦ºåŒ–å¯¦é©—å ±å‘Š</h2><h4>è™•ç†çµæœå ±å‘Šï¼š</h4><ul><li><b>æˆæœï¼š</b> ä½¿ç”¨ç•¶å‰åƒæ•¸ï¼ŒæˆåŠŸæ‰¾åˆ°äº† <b>{len(found_charts_data)}</b> å€‹ç‰©ä»¶ã€‚</li></ul>'
    if found_charts_data:
        areas = [d['area']/1000 for d in found_charts_data]; ratios = [d['aspect_ratio'] for d in found_charts_data]
        min_a, max_a, avg_a = min(areas), max(areas), np.mean(areas); min_r, max_r, avg_r = min(ratios), max(ratios), np.mean(ratios)
        rec_min_area = int(min_a*0.95); rec_max_area = int(max_a*1.05); rec_min_ratio = round(min_r*0.95,2); rec_max_ratio = round(max_r*1.05,2)
        report_html += f"""<details><summary>â–º æ™ºæ…§åƒæ•¸æ¨è–¦</summary><div><p>æ ¹æ“šæœ¬æ¬¡åˆ†æï¼Œå»ºè­°æ‚¨å°‡ã€ç¬¬äºŒå€ã€‘çš„ç¯©é¸åƒæ•¸æ›´æ–°ç‚ºä»¥ä¸‹æ•¸å€¼ï¼š</p><table><thead><tr><th>åƒæ•¸åç¨±</th><th>å»ºè­°å€¼</th><th>æ•¸æ“šæ´å¯Ÿ (æœ€å° / å¹³å‡ / æœ€å¤§)</th></tr></thead><tbody>
        <tr><td><b>min_chart_area_k</b></td><td><code>{rec_min_area}</code></td><td rowspan="2">{min_a:.1f}k / {avg_a:.1f}k / {max_a:.1f}k</td></tr>
        <tr><td><b>max_chart_area_k</b></td><td><code>{rec_max_area}</code></td></tr>
        <tr><td><b>min_aspect_ratio</b></td><td><code>{rec_min_ratio}</code></td><td rowspan="2">{min_r:.2f} / {avg_r:.2f} / {max_r:.2f}</td></tr>
        <tr><td><b>max_aspect_ratio</b></td><td><code>{rec_max_ratio}</code></td></tr></tbody></table></div></details>"""
    report_html += "</div>"; display(HTML(report_html))

    # --- æ­¥é©Ÿ 3: é¡¯ç¤ºè¼ªå»“åˆ†æåœ– ---
    analysis_image = original_image.copy()
    for item in all_contours_for_viz:
        color = (0, 255, 0) if item['accepted'] else (0, 0, 255)
        cv2.drawContours(analysis_image, [item['contour']], -1, color, 3)
    display(HTML('<div class="report-container"><h4>1. ã€Œæˆ‘å¦‚ä½•æ‰¾åˆ°å®ƒå€‘ã€â€”â€” è¼ªå»“åˆ†æåœ– (ç¶ è‰²=ç¬¦åˆæ¢ä»¶, ç´…è‰²=å·²æ¨æ£„)</h4></div>'))
    display(Image.fromarray(cv2.cvtColor(analysis_image, cv2.COLOR_BGR2RGB)))

    # --- æ­¥é©Ÿ 4: éæ­·æ¯ä¸€å€‹æ‰¾åˆ°çš„åœ–è¡¨ï¼Œé€²è¡Œç›´æ¥è£åˆ‡ä¸¦å±•ç¤º ---
    display(HTML('<div class="report-container"><h4>2. ã€Œé€™æ˜¯æˆ‘çš„æˆæœã€â€”â€” æœ€çµ‚æ“·å–æˆå“</h4></div>'))
    if not found_charts_data:
        print("ğŸ”´ æœªæ‰¾åˆ°ä»»ä½•ç¬¦åˆæ¢ä»¶çš„ç‰©ä»¶ã€‚è«‹åƒè€ƒä¸Šæ–¹çš„åˆ†æåœ–ï¼Œèª¿æ•´åƒæ•¸å¾Œå†è©¦ä¸€æ¬¡ã€‚")
    else:
        found_charts_data.sort(key=lambda d: (d['rect'][1] // 100, d['rect'][0] // 100))
        for i, data in enumerate(found_charts_data):
            # æ ¸å¿ƒæ­¥é©Ÿï¼šåªé€²è¡Œè£åˆ‡ï¼Œä¸é€²è¡Œä»»ä½•æ ¡æ­£
            x, y, w, h = data['rect']
            long_edge = max(w, h)
            padding = int(long_edge * (padding_expansion_percent / 100.0))

            # è¨ˆç®—æ“´å±•å¾Œçš„è£åˆ‡ç¯„åœï¼Œä¸¦ç¢ºä¿ä¸è¶…å‡ºåŸåœ–é‚Šç•Œ
            y_start = max(0, y - padding)
            y_end = min(original_image.shape[0], y + h + padding)
            x_start = max(0, x - padding)
            x_end = min(original_image.shape[1], x + w + padding)

            # å¾åŸå§‹åœ–ç‰‡ä¸­ç›´æ¥è£åˆ‡
            final_crop = original_image[y_start:y_end, x_start:x_end]

            if final_crop.size > 0:
                # é¡¯ç¤ºæˆå“èˆ‡å±¬æ€§å ±å‘Š
                property_report_html = f"""<div class="report-container" style="margin-top:10px;margin-bottom:25px;"><h4 style="margin-top:0;">ç‰©ä»¶ #{i+1} å±¬æ€§å ±å‘Š</h4><table><thead><tr><th>å±¬æ€§</th><th>æ•¸å€¼</th></tr></thead><tbody>
                <tr><td><b>è¼ªå»“é¢ç©</b></td><td><code>{data['area']/1000:.1f} k</code></td></tr>
                <tr><td><b>åŸå§‹é‚Šç•Œæ¡† (W x H)</b></td><td><code>{data['rect'][2]} x {data['rect'][3]}</code> åƒç´ </td></tr>
                <tr><td><b>é•·å¯¬æ¯”</b></td><td><code>{data['aspect_ratio']:.2f}</code></td></tr>
                </tbody></table></div>"""
                display(HTML(f"<hr><h3>ç‰©ä»¶ #{i+1}</h3>"))
                display(Image.fromarray(cv2.cvtColor(final_crop, cv2.COLOR_BGR2RGB)))
                display(HTML(property_report_html))

# ==============================================================================
# Part D: ä½¿ç”¨è€…äº’å‹•ä»‹é¢
# ==============================================================================
def on_upload(change):
    """è™•ç†æª”æ¡ˆä¸Šå‚³äº‹ä»¶çš„å‡½å¼ã€‚"""
    if not change.new: return
    uploaded_file = change.owner
    if not uploaded_file.value: return
    file_content = uploaded_file.value[list(uploaded_file.value.keys())[0]]['content']
    process_image_and_report(file_content)
    uploaded_file.value.clear(); uploaded_file._counter = 0

print("âœ… ç’°å¢ƒæº–å‚™å®Œæˆã€‚")
display(HTML("<h3>ğŸ”µ è«‹ä¸Šå‚³æ‚¨çš„æ›¸é åœ–ç‰‡</h3><p>ç¨‹å¼å°‡ä½¿ç”¨æ‚¨åœ¨é ‚éƒ¨è¨­å®šçš„åƒæ•¸é€²è¡Œè™•ç†èˆ‡åˆ†æã€‚</p>"))
uploader = widgets.FileUpload(accept='image/*', multiple=False, description='é¸æ“‡æª”æ¡ˆ')
uploader.observe(on_upload, names='value')
display(uploader)
