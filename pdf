
#@title ğŸš€ æœ€çµ‚é è¦½ç‰ˆï¼šä¸€éµç”Ÿæˆä¸¦å…§åµŒé¡¯ç¤ºPDFå ±å‘Š
#@markdown > **æ“ä½œèªªæ˜ï¼š**
#@markdown > 1. **åŸ·è¡Œæ­¤å„²å­˜æ ¼**ï¼šå®ƒæœƒè‡ªå‹•æº–å‚™ç’°å¢ƒã€å°‡å­—é«”å®‰è£åˆ°ç³»çµ±ï¼Œä¸¦ç”Ÿæˆ PDF å ±å‘Šã€‚
#@markdown > 2. **ç›´æ¥é è¦½**ï¼šåŸ·è¡Œå®Œç•¢å¾Œï¼Œç”Ÿæˆçš„ PDF å°‡æœƒ**ç›´æ¥é¡¯ç¤ºåœ¨æ­¤å„²å­˜æ ¼ä¸‹æ–¹**ã€‚
#@markdown > 3. **å‚™ç”¨ä¸‹è¼‰**ï¼šä¸‹æ–¹åŒæ™‚æœƒæä¾›ä¸€å€‹ä¸‹è¼‰æŒ‰éˆ•ï¼Œä¾›æ‚¨é¸æ“‡æ€§ä¸‹è¼‰ã€‚

# ==============================================================================
# éšæ®µé›¶ï¼šç’°å¢ƒè‡ªæˆ‘æª¢æŸ¥èˆ‡æº–å‚™ (Phase 0: Environment Self-Check & Setup)
# ==============================================================================
import sys
import subprocess
import os
import base64 # å°å…¥ base64 æ¨¡çµ„ï¼Œç”¨æ–¼å°‡ PDF è½‰æ›ç‚ºå¯åµŒå…¥çš„æ ¼å¼

def setup_environment():
    """
    ä¸€å€‹æ•´åˆçš„å‡½å¼ï¼Œç”¨æ–¼æª¢æŸ¥ä¸¦å®‰è£æ‰€æœ‰å¿…è¦çš„ Python å¥—ä»¶èˆ‡ç³»çµ±ä¾è³´ã€‚
    """
    print("ğŸš€ æ­£åœ¨å•Ÿå‹•ç’°å¢ƒè‡ªæˆ‘æª¢æŸ¥ç¨‹åº...")
    required_packages = ['gdown', 'weasyprint', 'pytz', 'ipywidgets']

    reqs = subprocess.check_output([sys.executable, '-m', 'pip', 'list'])
    installed_packages = [r.decode().split(' ')[0] for r in reqs.split()]

    for package in required_packages:
        if package in installed_packages:
            print(f"âœ… Python å¥—ä»¶ '{package}' å·²å­˜åœ¨ï¼Œç„¡éœ€å®‰è£ã€‚")
        else:
            print(f"â³ æ­£åœ¨å®‰è£ Python å¥—ä»¶ '{package}'...")
            subprocess.check_call([sys.executable, '-m', 'pip', 'install', '-q', package])
            print(f"ğŸ‘ Python å¥—ä»¶ '{package}' å®‰è£æˆåŠŸï¼")

    print("\n[ç³»çµ±ä¾è³´] æ­£åœ¨æ›´æ–° apt å¥—ä»¶åº«ä¸¦å®‰è£ Pango (ç”¨æ–¼æ–‡å­—æ¸²æŸ“)...")
    subprocess.run(['apt-get', 'update', '-qq'])
    subprocess.run(['apt-get', 'install', '-y', 'libpango-1.0-0', 'libpangoft2-1.0-0', '-qq'])
    print("\nâœ¨ ç’°å¢ƒæº–å‚™å®Œæˆï¼å³å°‡é–‹å§‹åŸ·è¡Œæ ¸å¿ƒä»»å‹™... âœ¨")

# --- åŸ·è¡Œç’°å¢ƒæº–å‚™ ---
setup_environment()

# ==============================================================================
# æ ¸å¿ƒä»»å‹™ï¼šç”Ÿæˆ PDF ä¸¦å…§åµŒé¡¯ç¤º
# ==============================================================================
import zipfile
import glob
import gdown
from weasyprint import HTML, CSS
from datetime import datetime
import pytz
import ipywidgets as widgets
from IPython.display import display, HTML as IPHTML

# --- 1. æº–å‚™å·¥ä½œï¼šç²å–å­—é«”ã€å®‰è£åˆ°ç³»çµ±ä¸¦è¨­å®šæª”å ---
print("\n[1/3] æ­£åœ¨æº–å‚™è³‡æº...")
google_drive_file_id = '1NKofD5jLOI762WNvCdJNpmZQoJ5D95mG'
local_zip_filename = 'Noto_Sans_TC.zip'
extract_path = '/content/font_assets'
target_font_filename = 'NotoSansTC-Regular.ttf'
output_pdf_path = None

try:
    # æ­¥é©Ÿ 1a: è‡ªå‹•åŒ–ç²å–å­—é«”
    print("   -> æ­£åœ¨å¾ Google Drive ç²å–å­—é«”...")
    gdown.download(id=google_drive_file_id, output=local_zip_filename, quiet=True)
    os.makedirs(extract_path, exist_ok=True)
    with zipfile.ZipFile(local_zip_filename, 'r') as zip_ref:
        zip_ref.extractall(extract_path)

    search_pattern = os.path.join(extract_path, '**', target_font_filename)
    search_results = glob.glob(search_pattern, recursive=True)
    if not search_results:
        raise RuntimeError("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è§£å£“ç¸®å¾Œçš„å­—é«”æª”æ¡ˆï¼")
    found_font_path = search_results[0]

    # æ­¥é©Ÿ 1b: å°‡å­—é«”å®‰è£åˆ°ç³»çµ±ç›®éŒ„
    print("   -> æ­£åœ¨å°‡å­—é«”å®‰è£åˆ° Colab ç³»çµ±ä¸­...")
    font_dir = '/usr/share/fonts/truetype/noto'
    os.makedirs(font_dir, exist_ok=True)
    subprocess.run(['cp', found_font_path, font_dir])
    subprocess.run(['fc-cache', '-f', '-v'], capture_output=True)
    print("   -> âœ… å­—é«”æˆåŠŸå®‰è£è‡³ç³»çµ±ï¼")

    # æ­¥é©Ÿ 1c: æ ¹æ“šç•¶å‰æ™‚é–“ç”Ÿæˆæª”å
    print("   -> æ­£åœ¨ç”Ÿæˆæ™‚é–“æˆ³æª”å...")
    taiwan_tz = pytz.timezone('Asia/Taipei')
    now_in_taiwan = datetime.now(taiwan_tz)
    timestamp = now_in_taiwan.strftime('%Y%m%d_%H%M%S')
    output_pdf_filename = f'PreviewReport_{timestamp}.pdf'
    output_pdf_path = f'/content/{output_pdf_filename}'
    print(f"   -> âœ… å ±å‘Šæª”åè¨­å®šç‚º: {output_pdf_filename}")

except Exception as e:
    print(f"âŒ è³‡æºæº–å‚™å¤±æ•—: {e}")

# --- 2. å®šç¾© HTML å…§å®¹èˆ‡ CSS æ¨£å¼ ---
if output_pdf_path:
    print("\n[2/3] æ­£åœ¨å®šç¾© HTML å…§å®¹èˆ‡ CSS æ¨£å¼...")
    html_content = f"""
    <html><head><meta charset="UTF-8"></head><body>
        <h1>æ³¡æ°´æ›¸æ•¸ä½åŒ–é‡å»ºå°ˆæ¡ˆ</h1>
        <h2>å…§åµŒé è¦½é©—è­‰å ±å‘Š</h2>
        <p>é€™ä»½å ±å‘Šé©—è­‰äº†**ç³»çµ±ç´šå­—é«”å®‰è£**èˆ‡**å…§åµŒé¡¯ç¤º**æ–¹æ¡ˆçš„æˆåŠŸã€‚</p>
        <ol>
            <li>æ‰€æœ‰ä¾è³´å·²è‡ªå‹•å®‰è£ã€‚</li>
            <li>å­—é«”å·²æˆåŠŸå®‰è£è‡³ç³»çµ±ã€‚</li>
            <li><strong>é€™ä»½ PDF å ±å‘Šè¢«ç›´æ¥åµŒå…¥åœ¨ Colab è¼¸å‡ºæ¬„ä½ä¸­ã€‚</strong></li>
        </ol>
        <hr><p style="color: #555; font-size: 12px;">å ±å‘Šç”Ÿæˆæ™‚é–“: {now_in_taiwan.strftime('%Y-%m-%d %H:%M:%S %Z')}</p>
    </body></html>
    """
    css_style = """
    body { font-family: 'Noto Sans TC', sans-serif; font-size: 14px; line-height: 1.8; }
    h1, h2 { color: #2c3e50; }
    """

    # --- 3. åŸ·è¡Œæ¸²æŸ“ä¸¦å…§åµŒé¡¯ç¤º ---
    print("\n[3/3] æ­£åœ¨æ¸²æŸ“ PDF ä¸¦æº–å‚™å…§åµŒé è¦½...")
    HTML(string=html_content).write_pdf(
        output_pdf_path,
        stylesheets=[CSS(string=css_style)]
    )

    print("\n" + "="*50)
    print("ğŸ‰ğŸ‰ğŸ‰ ä»»å‹™åœ“æ»¿æˆåŠŸï¼PDF å·²ç”Ÿæˆï¼ ğŸ‰ğŸ‰ğŸ‰")
    print("="*50)

    # =========================================
    #  â˜…â˜…â˜… é—œ éµ å‡ ç´š é» â˜…â˜…â˜…
    # =========================================
    # æ­¥é©Ÿ 3a: è®€å– PDF æª”æ¡ˆä¸¦é€²è¡Œ Base64 ç·¨ç¢¼
    with open(output_pdf_path, "rb") as f:
        base64_pdf = base64.b64encode(f.read()).decode('utf-8')

    # æ­¥é©Ÿ 3b: å»ºç«‹ä¸€å€‹å¯ä»¥å…§åµŒé¡¯ç¤º PDF çš„ HTML iframe
    # æˆ‘å€‘è¨­å®šäº†å¯¬åº¦å’Œé«˜åº¦ï¼Œè®“å®ƒåœ¨è¼¸å‡ºå€åŸŸæœ‰è¶³å¤ çš„ç©ºé–“é¡¯ç¤º
    pdf_display = f'<iframe src="data:application/pdf;base64,{base64_pdf}" width="95%" height="400px"></iframe>'

    print("ğŸ‘‡ **PDF å…§åµŒé è¦½ï¼š**")
    # é¡¯ç¤ºå…§åµŒçš„ PDF
    display(IPHTML(pdf_display))

    # æ­¥é©Ÿ 3c: (å‚™ç”¨) å»ºç«‹ä¸€å€‹äº’å‹•å¼ä¸‹è¼‰æŒ‰éˆ•
    print("\nğŸ‘‡ **å‚™ç”¨ä¸‹è¼‰é¸é …ï¼š**")
    button = widgets.Button(description="ğŸ“„ é»æ­¤ä¸‹è¼‰ PDF å ±å‘Š", button_style='primary', tooltip='é»æ“Šä¸‹è¼‰', icon='download')
    output = widgets.Output()

    def on_button_clicked(b):
        with output:
            output.clear_output()
            from google.colab import files
            files.download(output_pdf_path)

    button.on_click(on_button_clicked)
    display(button, output)
else:
    print("\n" + "="*50)
    print("âŒ PDF ç”Ÿæˆå¤±æ•—ï¼Œå› ç‚ºå‰ç½®è³‡æºæº–å‚™å‡ºéŒ¯ï¼Œå·²è·³éæ­¤æ­¥é©Ÿã€‚")
    print("="*50)
